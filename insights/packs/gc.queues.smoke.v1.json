{
  "id": "gc.queues.smoke.v1",
  "name": "Queue Smoke Detector",
  "version": "1.1.0",
  "maturity": "alpha",
  "owner": "Ops Insights",
  "expectedRuntimeSec": 60,
  "description": "Ranks queues and agents by failure indicators for a time window using the existing smoke report function, and enriches top queues with queue metadata for blast radius.",
  "scopes": ["analytics:read", "routing:read"],
  "tags": ["queues", "operations", "triage"],
  "evidenceScript": "param($ctx)\n\n$topQueues = @($ctx.Data.topQueuesEnriched)\n$worst = if ($topQueues.Count -gt 0) { $topQueues[0] } else { $null }\n\n$severity = 'Info'\nif ($worst) {\n  if ([double]$worst.AbandonRate -ge 10 -or [double]$worst.ErrorRate -ge 5) { $severity = 'Warning' }\n  if ([double]$worst.AbandonRate -ge 20 -or [double]$worst.ErrorRate -ge 10) { $severity = 'Critical' }\n}\n\n$impact = if ($worst) {\n  $qName = if ($worst.Queue -and $worst.Queue.name) { $worst.Queue.name } else { $worst.QueueId }\n  \"Top queue: $qName (abandon=$($worst.AbandonRate)% error=$($worst.ErrorRate)% offered=$($worst.Offered))\"\n} else {\n  'No queue offenders found in the selected window.'\n}\n\n$blast = [pscustomobject]@{\n  Queues = @(\n    $topQueues | Select-Object -First 10 | ForEach-Object {\n      $qName = if ($_.Queue -and $_.Queue.name) { $_.Queue.name } else { $_.QueueId }\n      \"$qName [$($_.QueueId)]\"\n    }\n  )\n}\n\n$causes = New-Object System.Collections.Generic.List[string]\n$actions = New-Object System.Collections.Generic.List[string]\n\nif ($worst) {\n  $causes.Add('Queue abandonment or error spikes are commonly driven by staffing gaps, upstream outages, or routing configuration changes.') | Out-Null\n  $actions.Add('Validate staffing vs offered volume and confirm service level targets align to current demand.') | Out-Null\n  $actions.Add('Review recent routing changes (skills/bullseye/rules) for the affected queues.') | Out-Null\n  $actions.Add('If errors are elevated, inspect agent connectivity and edge/network health during the window.') | Out-Null\n}\n\nreturn [pscustomobject]@{\n  Severity = $severity\n  Impact = $impact\n  LikelyCauses = @($causes)\n  RecommendedActions = @($actions)\n  WhyThisMatters = 'Queue health is a primary operational signal; sustained abandons/errors directly impact customer experience and staffing decisions.'\n  BlastRadius = $blast\n}\n",
  "examples": [
    {
      "title": "Top 10 offenders",
      "notes": "Use a week window via the UI Window preset; this example sets topN.",
      "parameters": {
        "topN": 10
      }
    }
  ],
  "parameters": {
    "startDate": {
      "type": "string",
      "required": true,
      "description": "ISO-8601 UTC start timestamp (e.g. 2025-12-01T00:00:00Z)."
    },
    "endDate": {
      "type": "string",
      "required": true,
      "description": "ISO-8601 UTC end timestamp (e.g. 2025-12-08T00:00:00Z)."
    },
    "topN": {
      "type": "int",
      "default": 10,
      "description": "How many queues/agents to rank."
    }
  },
  "pipeline": [
    {
      "id": "smoke",
      "type": "cache",
      "ttlMinutes": 60,
      "keyTemplate": "{{startDate}}/{{endDate}}|topN={{topN}}",
      "script": "param($ctx)\n# Build Genesys 'interval' range\n$interval = \"$($ctx.Parameters.startDate)/$($ctx.Parameters.endDate)\"\nGet-GCQueueSmokeReport -Interval $interval -TopN ([int]$ctx.Parameters.topN)\n"
    },
    {
      "id": "topQueuesEnriched",
      "type": "join",
      "sourceStepId": "smoke",
      "itemsProperty": "QueueTop",
      "key": "QueueId",
      "assign": "Queue",
      "maxUnique": 25,
      "lookup": {
        "method": "GET",
        "uri": "/api/v2/routing/queues/{id}"
      }
    },
    {
      "id": "metricQueues",
      "type": "metric",
      "script": "param($ctx)\n$top = @($ctx.Data.topQueuesEnriched)\n[pscustomobject]@{ title='Top Queues (Abandon/Error)'; value=$top.Count; items=$top }\n"
    },
    {
      "id": "metricAgents",
      "type": "metric",
      "script": "param($ctx)\n$top = @($ctx.Data.smoke.AgentTop)\n[pscustomobject]@{ title='Top Agents (Abandon/Error)'; value=$top.Count; items=$top }\n"
    },
    {
      "id": "drilldownQueueOffenders",
      "type": "drilldown",
      "script": "param($ctx)\n$top = @($ctx.Data.topQueuesEnriched)\n[pscustomobject]@{ title='Top Queue Offenders (Enriched)'; items=$top }\n"
    }
  ]
}
