{
  "id": "gc.dataActions.failures.enriched.v1",
  "name": "Data Action Failures (Enriched)",
  "version": "1.0.0",
  "maturity": "alpha",
  "owner": "Ops Insights",
  "expectedRuntimeSec": 90,
  "description": "Ranks Data Actions by failures for a time window and enriches results with action + integration metadata and response-code breakdowns.",
  "scopes": ["analytics:read", "integrations:read", "architect:readonly"],
  "tags": ["data-actions", "integrations", "reliability", "triage"],
  "evidenceScript": "param($ctx)\n\n$items = @($ctx.Data.enrichedTopActions)\n$worst = if ($items.Count -gt 0) { $items[0] } else { $null }\n$totalErrors = 0\nforeach ($i in $items) { try { $totalErrors += [int]$i.errorCount } catch {} }\n\n$severity = 'Info'\nif ($totalErrors -ge 50) { $severity = 'Warning' }\nif ($totalErrors -ge 200) { $severity = 'Critical' }\n\n$impact = if ($totalErrors -gt 0) { \"${totalErrors} Data Action errors in the selected window.\" } else { 'No Data Action errors detected in the selected window.' }\n\n$flows = @()\ntry {\n  if ($ctx.Data.actionFlowBlastRadius -and ($ctx.Data.actionFlowBlastRadius.PSObject.Properties.Name -contains 'Flows')) {\n    $flows = @($ctx.Data.actionFlowBlastRadius.Flows)\n  }\n} catch {}\n\n$blast = [pscustomobject]@{\n  Actions = @($items | Select-Object -First 10 | ForEach-Object { if ($_.actionName) { $_.actionName } else { $_.actionId } })\n  Integrations = @($items | Where-Object { $_.integrationName } | Select-Object -First 10 -ExpandProperty integrationName)\n  Flows = @($flows | Select-Object -First 15)\n}\n\n$causes = New-Object System.Collections.Generic.List[string]\n$actions = New-Object System.Collections.Generic.List[string]\n$why = 'Data Action reliability is a leading indicator of downstream system health and directly impacts automation success and customer experience.'\n\nif ($worst) {\n  $causes.Add(\"Top failing action: $($worst.actionName) (integration: $((if ($worst.integrationName) { $worst.integrationName } else { 'unknown' })))\") | Out-Null\n  if ($worst.topResponseCodes -and $worst.topResponseCodes.Count -gt 0) {\n    $codes = ($worst.topResponseCodes | ForEach-Object { \"$($_.responseCode):$($_.errorCount)\" }) -join ', '\n    $causes.Add(\"Top response codes: $codes\") | Out-Null\n  }\n\n  if ($flows.Count -gt 0) {\n    $causes.Add(\"Flows using top failing actions: $((@($flows | Select-Object -First 10) -join ', '))\") | Out-Null\n  }\n\n  $actions.Add('Validate integration credentials, certificates, and endpoint reachability for the associated integration.') | Out-Null\n  $actions.Add('Review the action contract mapping and recent contract changes; confirm downstream API behavior.') | Out-Null\n  $actions.Add('Inspect Architect flows that call the top failing actions for retry/timeout handling and fallback paths.') | Out-Null\n}\n\nreturn [pscustomobject]@{\n  Severity = $severity\n  Impact = $impact\n  LikelyCauses = @($causes)\n  RecommendedActions = @($actions)\n  WhyThisMatters = $why\n  BlastRadius = $blast\n}\n",
  "examples": [
    {
      "title": "Hourly failures with enrichment",
      "notes": "Use the UI Window preset to set start/end; this example sets granularity + topN.",
      "parameters": {
        "granularity": "PT1H",
        "topN": 10
      }
    }
  ],
  "parameters": {
    "startDate": {
      "type": "string",
      "required": true,
      "description": "ISO-8601 UTC start timestamp (e.g. 2025-12-01T00:00:00Z)."
    },
    "endDate": {
      "type": "string",
      "required": true,
      "description": "ISO-8601 UTC end timestamp (e.g. 2025-12-08T00:00:00Z)."
    },
    "granularity": {
      "type": "string",
      "default": "PT1H",
      "description": "Analytics aggregation granularity (e.g. PT15M, PT1H, P1D)."
    },
    "topN": {
      "type": "int",
      "default": 10,
      "description": "How many actions to enrich and report."
    }
  },
  "pipeline": [
    {
      "id": "actionsAgg",
      "type": "gcRequest",
      "method": "POST",
      "uri": "/api/v2/analytics/actions/aggregates/query",
      "bodyTemplate": {
        "interval": "{{startDate}}/{{endDate}}",
        "granularity": "{{granularity}}",
        "filter": {
          "type": "or",
          "clauses": []
        },
        "metrics": ["oTotalCount", "oErrorCount"],
        "groupBy": ["actionId"],
        "timeZone": "UTC"
      }
    },
    {
      "id": "topActions",
      "type": "compute",
      "script": "param($ctx)\n$rows = @($ctx.Data.actionsAgg.results)\n$rows | Sort-Object -Property { $_.data.oErrorCount } -Descending | Select-Object -First ([int]$ctx.Parameters.topN)\n"
    },
    {
      "id": "topActionStats",
      "type": "compute",
      "script": "param($ctx)\nfunction SafeInt($v) { if ($null -eq $v) { return 0 } try { return [int]$v } catch { return 0 } }\n$items = foreach ($row in @($ctx.Data.topActions)) {\n  $actionId = $row.group.actionId\n  [pscustomobject]@{\n    actionId = $actionId\n    totalCount = (SafeInt $row.data.oTotalCount)\n    errorCount = (SafeInt $row.data.oErrorCount)\n  }\n}\n$items\n"
    },
    {
      "id": "actionsWithMeta",
      "type": "join",
      "sourceStepId": "topActionStats",
      "key": "actionId",
      "assign": "action",
      "maxUnique": 20,
      "lookup": {
        "method": "GET",
        "uri": "/api/v2/integrations/actions/{id}"
      }
    },
    {
      "id": "actionFlowBlastRadius",
      "type": "cache",
      "ttlMinutes": 180,
      "keyTemplate": "{{startDate}}/{{endDate}}|topN={{topN}}|flows",
      "script": "param($ctx)\n\nfunction SafeString($v) { if ($null -eq $v) { return '' } try { return [string]$v } catch { return '' } }\n\n$flows = New-Object System.Collections.Generic.HashSet[string]\n$byAction = New-Object System.Collections.ArrayList\n\nforeach ($row in @($ctx.Data.actionsWithMeta)) {\n  if (-not $row) { continue }\n  $actionId = SafeString $row.actionId\n  if ([string]::IsNullOrWhiteSpace($actionId)) { continue }\n\n  $actionName = $actionId\n  try {\n    if ($row.action -and ($row.action.PSObject.Properties.Name -contains 'name') -and $row.action.name) {\n      $actionName = [string]$row.action.name\n    }\n  } catch {}\n\n  $path = \"/api/v2/architect/dependencytracking/object?id=$([System.Uri]::EscapeDataString($actionId))&consumingResources=true\"\n  $deps = @()\n  try {\n    $obj = Invoke-GCRequest -Method GET -Path $path\n    if ($obj -and $obj.consumingResources) {\n      $deps = @($obj.consumingResources | Where-Object { $_ -and $_.type -and ([string]$_.type -match 'flow') })\n    }\n  } catch {}\n\n  foreach ($d in $deps) {\n    try {\n      $name = if ($d.name) { [string]$d.name } else { [string]$d.id }\n      $type = if ($d.type) { [string]$d.type } else { '' }\n      $label = if ($type) { \"$name ($type)\" } else { $name }\n      if (-not [string]::IsNullOrWhiteSpace($label)) { [void]$flows.Add($label) }\n    } catch {}\n  }\n\n  [void]$byAction.Add([pscustomobject]@{ actionId=$actionId; actionName=$actionName; flowCount=$deps.Count; flows=@($deps) })\n}\n\nreturn [pscustomobject]@{\n  Flows = @($flows | Sort-Object)\n  ByAction = @($byAction)\n}\n"
    },
    {
      "id": "actionsWithIntegrationId",
      "type": "compute",
      "script": "param($ctx)\nforeach ($row in @($ctx.Data.actionsWithMeta)) {\n  $integrationId = $null\n  if ($row.action -and ($row.action.PSObject.Properties.Name -contains 'integrationId')) { $integrationId = $row.action.integrationId }\n  $row | Add-Member -MemberType NoteProperty -Name integrationId -Value $integrationId -Force\n  $row\n}\n"
    },
    {
      "id": "actionsWithIntegration",
      "type": "join",
      "sourceStepId": "actionsWithIntegrationId",
      "key": "integrationId",
      "assign": "integration",
      "maxUnique": 20,
      "lookup": {
        "method": "GET",
        "uri": "/api/v2/integrations/{id}"
      }
    },
    {
      "id": "responseCodesAgg",
      "type": "gcRequest",
      "method": "POST",
      "uri": "/api/v2/analytics/actions/aggregates/query",
      "bodyTemplate": {
        "interval": "{{startDate}}/{{endDate}}",
        "granularity": "{{granularity}}",
        "filter": {
          "type": "or",
          "clauses": []
        },
        "metrics": ["oErrorCount"],
        "groupBy": ["actionId", "responseCode"],
        "timeZone": "UTC"
      }
    },
    {
      "id": "enrichedTopActions",
      "type": "compute",
      "script": "param($ctx)\n$rows = @($ctx.Data.actionsWithIntegration)\n$codes = @($ctx.Data.responseCodesAgg.results)\n\nfunction SafeInt($v) { if ($null -eq $v) { return 0 } try { return [int]$v } catch { return 0 } }\n\n$enriched = foreach ($row in $rows) {\n  $actionId = [string]$row.actionId\n  $total = SafeInt $row.totalCount\n  $errors = SafeInt $row.errorCount\n  $rate = if ($total -gt 0) { [math]::Round(($errors / $total) * 100, 2) } else { $null }\n\n  $action = $row.action\n  $integration = $row.integration\n\n  $integrationId = if ($row.integrationId) { [string]$row.integrationId } elseif ($action -and ($action.PSObject.Properties.Name -contains 'integrationId')) { [string]$action.integrationId } else { $null }\n\n  $actionName = if ($action -and $action.name) { [string]$action.name } else { $actionId }\n  $category = if ($action -and ($action.PSObject.Properties.Name -contains 'category') -and $action.category) { [string]$action.category } else { $null }\n  $integrationName = if ($integration -and $integration.name) { [string]$integration.name } else { $null }\n\n  $codeRows = $codes | Where-Object { $_.group.actionId -eq $actionId }\n  $topCodes = $codeRows | Sort-Object -Property { $_.data.oErrorCount } -Descending | Select-Object -First 5 | ForEach-Object {\n    [pscustomobject]@{ responseCode = $_.group.responseCode; errorCount = (SafeInt $_.data.oErrorCount) }\n  }\n\n  [pscustomobject]@{\n    actionId = $actionId\n    actionName = $actionName\n    category = $category\n    integrationId = $integrationId\n    integrationName = $integrationName\n    totalCount = $total\n    errorCount = $errors\n    errorRatePercent = $rate\n    topResponseCodes = @($topCodes)\n  }\n}\n\n$enriched | Sort-Object errorCount -Descending\n"
    },
    {
      "id": "metricTopFailures",
      "type": "metric",
      "script": "param($ctx)\n$items = @($ctx.Data.enrichedTopActions)\n$headline = if ($items.Count -gt 0) { $items[0] } else { $null }\n[pscustomobject]@{\n  title = 'Top Data Actions by Error Count (Enriched)'\n  value = $items.Count\n  items = $items\n  headline = $headline\n}\n"
    },
    {
      "id": "drilldownTopFailures",
      "type": "drilldown",
      "script": "param($ctx)\n$items = @($ctx.Data.enrichedTopActions)\n[pscustomobject]@{\n  title='Top Failures (Enriched)'\n  items=$items\n}\n"
    }
  ]
}
